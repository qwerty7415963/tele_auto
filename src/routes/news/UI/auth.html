<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Login</title>
  </head>
  <body>
    <h1>Telegram Login</h1>
    <form id="qrCodeForm">
      <button type="submit">Generate QR Code</button>
    </form>
    <div id="qrCodeContainer" style="display: none">
      <canvas id="qrCodeCanvas"></canvas>
      <form id="qrCodeLoginForm">
        <label for="token">Token:</label>
        <input type="text" id="token" name="token" required /><br /><br />
        <button type="submit">Login</button>
      </form>
    </div>
    <script>
      document
        .getElementById('qrCodeForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault()

          const response = await fetch('/news/generateQRCode', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          })

          const result = await response.json()

          if (result.success) {
            document.getElementById('qrCodeForm').style.display = 'none'
            document.getElementById('qrCodeContainer').style.display = 'block'

            const canvas = document.getElementById('qrCodeCanvas')
            const ctx = canvas.getContext('2d')
            const img = new Image()
            img.onload = function () {
              canvas.width = img.width
              canvas.height = img.height
              ctx.drawImage(img, 0, 0)
            }
            img.src = result.QRCodeString
          } else {
            alert('QR code generation failed')
          }
        })

      document
        .getElementById('qrCodeLoginForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault()
          const token = document.getElementById('token').value

          const response = await fetch('/news/qrCodeLogin', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token }),
          })

          const result = await response.json()
          alert(result.message)
        })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  </body>
</html>
